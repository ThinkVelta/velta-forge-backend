name: Codex PR Change Summary
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  codex:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    outputs:
      final_message: ${{ steps.run_codex.outputs['final-message'] }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Fetch PR conversation
        id: fetch_conversation
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          result-encoding: string
          script: |
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              }
            );
            return comments
              .map(c => `@${c.user.login}: ${c.body}`)
              .join('\n---\n');

      - name: Fail fast on missing OPENAI_API_KEY
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "OPENAI_API_KEY is not set for this workflow run."
            exit 1
          fi

      - name: Prepare Codex home
        run: |
          mkdir -p "$HOME/.codex"
  
      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            Summarize all the changes between the previous version of this (`main`) branch, and the new edits made.
            Write in markdown format, with dedicated sections in headers.
            When generating tables, make sure they're formatted correctly and don't forget the header separator row.
            Include code snippets where appropriate, in properly formatted code blocks.
            Analyze and incorporate the conversation history to understand the context of the PR and previous feedback given by the developer.

            Format the change summary as follows:
              - A `## TL;DR` section, summarizing what the edit is about in a single paragraph.
              - A `## Change Overview` section, containing a tabular summary of the changes made (columns: `File`, `Summary`)
              - A `## Core Changes` section, depicing the most important changes introduced by this PR. Create a dedicated subsection `### <My-Change>` for each change you want to mention.

            Always review the complete change between the previous version of this (`main`) branch, and the latest version of the code found in this PR, even when the pull request got updated with new commits.

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

            Current PR's conversation history:
            ----
            ${{ steps.fetch_conversation.outputs.result }}

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if: needs.codex.outputs.final_message != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Report Codex feedback
        uses: actions/github-script@v8
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.CODEX_FINAL_MESSAGE,
            });
